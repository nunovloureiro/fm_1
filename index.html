<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>WebPd boilerplate</title>
    <style>
      #start {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #permissions {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #loading {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <h1>My Web Page</h1>
    <div>
      For more info about usage (how to interact with the patch), you can open this
      HTML file in a code editor.
    </div>
    <button id="start"> Start </button>
    <button id="permissions"> iOS? </button>
    <div id="loading"> Loading ... </div>
    <script src="webpd-runtime.js"></script>
    <script>
      // Utility function to detect iOS
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
          (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }

      // ------------- 1. WEB PAGE INITIALIZATION
      const loadingDiv = document.querySelector('#loading');
      const startButton = document.querySelector('#start');
      const permissionsButton = document.querySelector('#permissions');
      const audioContext = new AudioContext();

      let patch = null;
      let stream = null;
      let webpdNode = null;

      const initApp = async () => {
        // Register the worklet
        await WebPdRuntime.initialize(audioContext);

        // Fetch the patch code
        response = await fetch('patch.wasm');
        patch = await response.arrayBuffer();

        // Uncomment if you need audio input:
        // stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // Hide loading and show start button
        loadingDiv.style.display = 'none';
        startButton.style.display = 'block';
      };

      const startApp = async () => {
        // Resume AudioContext on user interaction
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // Setup web audio graph
        webpdNode = await WebPdRuntime.run(
          audioContext,
          patch,
          WebPdRuntime.defaultSettingsForRun(
            './patch.wasm',
            receiveMsgFromWebPd
          )
        );
        webpdNode.connect(audioContext.destination);

        // Uncomment if you need audio input:
        // const sourceNode = audioContext.createMediaStreamSource(stream);
        // sourceNode.connect(webpdNode);

        // Hide the start button
        startButton.style.display = 'none';

        if (isIOS()) {
          console.log("This device is running iOS.");
        //   permissionsButton.style.display = 'block';
        } else {
          console.log("This device is not iOS.");
        }
      };

    //   const askPermissions = async () => {
    //     try {
    //       const permissionState = await DeviceMotionEvent.requestPermission();
    //       if (permissionState !== "granted") {
    //         alert("Motion sensor permission denied. Some features may not work.");
    //         return;
    //       }
    //       // Permission granted; you can now proceed with your code.
    //     } catch (error) {
    //       console.error("Error requesting motion permission:", error);
    //       return;
    //     }
    //   };

      // ------------- 3. SENDING MESSAGES FROM THE PATCH TO JAVASCRIPT
      const receiveMsgFromWebPd = (nodeId, portletId, message) => {
        console.log(`Message from ${nodeId} (${portletId}):`, message);
      };

      const sendMsgToWebPd = (nodeId, portletId, message) => {
        webpdNode.port.postMessage({
          type: 'io:messageReceiver',
          payload: {
            nodeId,
            portletId,
            message,
          },
        });
      };

      startButton.onclick = startApp;
    //   permissionsButton.onclick = askPermissions;

      initApp().then(() => {
        console.log('App initialized');
      });
    </script>
  </body>
</html>
