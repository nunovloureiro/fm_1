<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>WebPd boilerplate</title>
    <style>
      #permissions {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #start {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #loading {
        width: 100%;
        height: 100%;
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <h1>My Web Page</h1>
    <div>
      For more info about usage (how to interact with the patch), you can open this HTML
      file in a code editor.
    </div>
    <button id="permissions"> iOS? </button>
    <button id="start"> Start </button>
    <div id="loading"> Loading ... </div>
    <script src="webpd-runtime.js"></script>
    <script>
      // ------------- 1. WEB PAGE INITIALIZATION
      const loadingDiv = document.querySelector("#loading");
      const permissionsButton = document.querySelector("#permissions");
      const startButton = document.querySelector("#start");
      const audioContext = new AudioContext();

      let patch = null;
      let stream = null;
      let webpdNode = null;

      const initApp = async () => {
        // Register the worklet
        await WebPdRuntime.initialize(audioContext);

        // Fetch the patch code
        const response = await fetch("patch.wasm");
        patch = await response.arrayBuffer();

        // (Optional) Request audio input if needed:
        // stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // Hide loading and show the permissions button
        loadingDiv.style.display = "none";
        permissionsButton.style.display = "none";
        startButton.style.display = "block";
      };

      // This function resumes audioContext immediately on user gesture,
      // then requests motion sensor permission.
      const checkPermissions = async () => {
        
        // If we reach here, motion permission (if needed) is granted.
        // Hide the permissions button and show the start button.
        //permissionsButton.style.display = "none";
        //startButton.style.display = "none";
      };

      // startApp can assume the AudioContext is already resumed.
      const startApp = async () => {

        // *** Resume AudioContext synchronously as part of the user gesture ***
        if (audioContext.state === "suspended") {
          try {
            await audioContext.resume();
            console.log("AudioContext resumed immediately on user gesture.");
          } catch (err) {
            console.error("Error resuming AudioContext:", err);
          }
        }

        // Now request motion sensor permission if needed (iOS 13+)
        if (
          typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function"
        ) {
          try {
            const permissionState = await DeviceMotionEvent.requestPermission();
            if (permissionState !== "granted") {
              alert("Motion sensor permission denied. Some features may not work.");
              return;
            }
          } catch (error) {
            console.error("Error requesting motion permission:", error);
            return;
          }
        }

        // Setup web audio graph
        webpdNode = await WebPdRuntime.run(
          audioContext,
          patch,
          WebPdRuntime.defaultSettingsForRun("./patch.wasm", receiveMsgFromWebPd)
        );
        webpdNode.connect(audioContext.destination);

        // (Optional) Setup audio input if needed:
        // const sourceNode = audioContext.createMediaStreamSource(stream);
        // sourceNode.connect(webpdNode);

        // Hide the start button after starting
        startButton.style.display = "none";
      };

    //   permissionsButton.onclick = checkPermissions;
      startButton.onclick = startApp;

      initApp().then(() => {
        console.log("App initialized");
      });

      // ------------- 3. SENDING MESSAGES FROM THE PATCH TO JAVASCRIPT
      const receiveMsgFromWebPd = (nodeId, portletId, message) => {
        // (Your message handling code here)
        console.log("Received message:", nodeId, portletId, message);
      };

      // ------------- 2. SENDING MESSAGES FROM JAVASCRIPT TO THE PATCH
      const sendMsgToWebPd = (nodeId, portletId, message) => {
        webpdNode.port.postMessage({
          type: "io:messageReceiver",
          payload: {
            nodeId,
            portletId,
            message,
          },
        });
      };
    </script>
  </body>
</html>
